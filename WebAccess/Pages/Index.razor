@page "/"
@using System.Net.WebSockets
@using System.Text
@using System.Threading
@using Google.Protobuf
@using System.IO 
@implements IDisposable
@inject AdminAccess.AdminAccessClient Client

<style>
  .mat-virtual-scroll-item {
    height: 150px;
  }
</style>

<div class="mat-layout-grid">
  <div class="mat-layout-grid-inner">
    <div class="mat-layout-grid-cell mat-layout-grid-cell-span-4">
      @*<MatButton OnClick="@OnNormalClick">Normal Tweet</MatButton>
    <MatButton OnClick="@OnRetweetedClick">Retweetet Tweet</MatButton>
    <MatButton OnClick="@OnQuotedClick">Quoted Tweet</MatButton>

    <MatButton OnClick="@OnPlayClick">Play</MatButton>

    <MatButton OnClick="@OnAddUserClick">Add User</MatButton>

    <MatButton OnClick="@OnWebSocketConnect">UseWebSocket</MatButton>*@

      <MatTextField @bind-Value="@NewUserHandle" Label="User Handle"></MatTextField>

      <MatButton OnClick="@OnAddUserClick">Add User</MatButton>

      <MatList>
        @foreach (var user in Items)
        {
          <WebAccess.Components.TwitterUserCard User="@user" />
        }
      </MatList>
    </div>
    </div>
    <div class="mat-layout-grid-cell mat-layout-grid-cell-span-3">
      
    <div class="mat-layout-grid-cell mat-layout-grid-cell-span-3">First level</div>
  </div>
</div>

@code
{

  public string NewUserHandle { get; set; }
  public List<TwitterUser> Items { get; set; } = new List<TwitterUser>();
  private QueueItem _queueItem;
  CancellationTokenSource disposalTokenSource = new CancellationTokenSource();
  private ClientWebSocket webSocket = new ClientWebSocket();

  public async Task OnNormalClick(MouseEventArgs e)
  {
    AddQueueRequest request = new AddQueueRequest();
    request.TweetId = 1300041598449917953L;

    var response = await Client.AddQueueItemAsync(request);
    _queueItem = response.Item;
  }

  public async Task OnRetweetedClick(MouseEventArgs e)
  {
    AddQueueRequest request = new AddQueueRequest();
    request.TweetId = 1303003523643330561L;

    var response = await Client.AddQueueItemAsync(request);
    _queueItem = response.Item;
  }

  public async Task OnQuotedClick(MouseEventArgs e)
  {
    AddQueueRequest request = new AddQueueRequest();
    request.TweetId = 1302684242971893760L;

    var response = await Client.AddQueueItemAsync(request);
    _queueItem = response.Item;
  }

  public async Task OnPlayClick(MouseEventArgs e)
  {
    ReadNextQueueItemsRequest request = new ReadNextQueueItemsRequest();
    var readResponse = await Client.ReadNextQueueItemsAsync(request);
  }

  public async Task OnAddUserClick()
  {
    var request = new GetTwitterUserRequest();
    request.Handle = NewUserHandle;
    request.VoiceName = "de-US-Wavenet-D";
    request.Language = "de-US";

    var response = await Client.AddTwitterUserAsync(request);

    NewUserHandle = null;
    StateHasChanged();
  }

  protected override async Task OnInitializedAsync()
  {
    var resp = await Client.GetAllTwitterUsersAsync(new GetAllTwitterUserRequest());
    Items = resp.Users.ToList();

    StateHasChanged();

    await webSocket.ConnectAsync(new Uri("ws://localhost:50080/connect"), disposalTokenSource.Token);
    _ = HandleMessageReceivingAsync();
  }

  public void Dispose()
  {
    _ = webSocket.CloseAsync(WebSocketCloseStatus.NormalClosure, "Bye", CancellationToken.None);

    disposalTokenSource.Cancel();
    disposalTokenSource.Dispose();

    webSocket.Dispose();
  }

  async Task HandleMessageReceivingAsync()
  {
    var buffer = new ArraySegment<byte>(new byte[2048]);
    while (!disposalTokenSource.IsCancellationRequested)
    {
      WebSocketReceiveResult received;
      using MemoryStream data = new MemoryStream();

      do
      {
        received = await webSocket.ReceiveAsync(buffer, disposalTokenSource.Token);
        Console.WriteLine("Received {0} b ({1})", received.Count, received.EndOfMessage);
        await data.WriteAsync(buffer.Slice(0, received.Count));
      } while (!received.EndOfMessage);

      try
      {
        data.Seek(0, SeekOrigin.Begin);
        var item = NotificationItem.Parser.ParseFrom(data);
        Console.WriteLine("Parsed `NotificationItem`: {0}", item != null);

        data.Seek(0, SeekOrigin.Begin);
        if(item.Type == NotificationType.UserChanged)
        {
          var userNotification = UserChangedNotification.Parser.ParseFrom(data);

          if (userNotification.NewUser != null)
            Items.Add(userNotification.NewUser);

          if (userNotification.OldUser != null)
            Items.Remove(userNotification.OldUser);

          StateHasChanged();
        }
      }
      catch (Exception e)
      {
        Console.WriteLine("Failed to Parse {0}", e.Message);
      }
    }
  }
}